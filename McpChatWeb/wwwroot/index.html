<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>COBOL Migration MCP Chat</title>
  <link rel="stylesheet" href="styles.css">
  <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ 
      startOnLoad: false,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#3b82f6',
        primaryTextColor: '#e2e8f0',
        primaryBorderColor: '#60a5fa',
        lineColor: '#94a3b8',
        secondaryColor: '#10b981',
        tertiaryColor: '#f59e0b',
        background: '#1e293b',
        mainBkg: '#1e293b',
        secondBkg: '#334155',
        textColor: '#e2e8f0',
        border1: '#475569',
        border2: '#64748b',
        fontSize: '14px'
      }
    });
    window.mermaid = mermaid;
  </script>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="header-left">
        <h1>COBOL Migration Insights</h1>
        <p>Ask questions about your COBOL code migration</p>
      </div>
      <div class="header-right">
        <div class="db-status-container">
          <div id="sqlite-status" class="status-indicator" title="SQLite Database">
            <span class="status-light"></span>
            <span class="status-label">SQLite</span>
          </div>
          <div id="neo4j-status" class="status-indicator" title="Neo4j Graph Database">
            <span class="status-light"></span>
            <span class="status-label">Neo4j</span>
          </div>
        </div>
      </div>
    </div>
    <div class="run-selector-container">
      <label for="run-selector">Migration Run:</label>
      <select id="run-selector" class="run-selector">
        <option value="">Loading runs...</option>
      </select>
      <button id="refresh-runs-btn" class="refresh-runs-btn" title="Refresh runs list">‚ü≥</button>
    </div>
  </header>

    <main>
    <section class="panel resources-panel">
      <h2>MCP Resources</h2>
      <button id="showAllRunsBtn" class="info-button">üìä View All Runs & Data Guide</button>
      <button id="showArchitectureBtn" class="info-button">üìÑ Architecture Documentation</button>
      <div id="resources-list" class="resource-list"></div>
    </section>

    <section class="panel chat-panel">
      <h2>Ask a Question</h2>
      
      <!-- Suggested Prompts -->
      <div id="suggestions" class="suggestions">
        <h3>üí° Try asking:</h3>
        <div class="suggestion-chips">
          <button class="suggestion-chip" data-prompt="What are the circular dependencies in this codebase?">üîÑ Circular Dependencies</button>
          <button class="suggestion-chip" data-prompt="Which files are most critical based on their connections?">‚≠ê Critical Files</button>
          <button class="suggestion-chip" data-prompt="Show me the impact analysis for BDSMFJL.cbl">üìä Impact Analysis</button>
          <button class="suggestion-chip" data-prompt="What copybooks are used most frequently?">üìö Copybook Usage</button>
          <button class="suggestion-chip" data-prompt="Summarize the dependency structure">üóÇÔ∏è Dependency Summary</button>
          <button class="suggestion-chip" data-prompt="What are the main programs in this migration?">üéØ Main Programs</button>
        </div>
      </div>
      
      <form id="chat-form">
        <label for="prompt">Prompt</label>
        <textarea id="prompt" rows="5" placeholder="e.g., What are the circular dependencies in this codebase?"></textarea>
        <button type="submit">Send</button>
      </form>
      
      <!-- Enhanced multi-stage loading indicator -->
      <div id="loading-indicator" class="loading-indicator" hidden>
        <div class="loading-stages">
          <div class="stage" id="stage-db">
            <div class="stage-icon">
              <div class="spinner-small"></div>
            </div>
            <div class="stage-info">
              <div class="stage-title">Database Query</div>
              <div class="stage-status">Fetching migration data...</div>
            </div>
          </div>
          
          <div class="stage-arrow">‚Üí</div>
          
          <div class="stage" id="stage-ai">
            <div class="stage-icon">
              <div class="spinner-small"></div>
            </div>
            <div class="stage-info">
              <div class="stage-title">Azure OpenAI</div>
              <div class="stage-status">Processing with AI model...</div>
            </div>
          </div>
          
          <div class="stage-arrow">‚Üí</div>
          
          <div class="stage" id="stage-response">
            <div class="stage-icon">
              <div class="spinner-small"></div>
            </div>
            <div class="stage-info">
              <div class="stage-title">Building Response</div>
              <div class="stage-status">Formatting results...</div>
            </div>
          </div>
        </div>
      </div>

      <article id="response" class="response" hidden>
        <h3>Response</h3>
        <pre id="response-body"></pre>
      </article>
    </section>

    <section class="panel graph-panel">
      <h2>Dependency Graph <span class="run-id-badge" id="graph-run-badge" style="display: none;">| Run <span id="current-run-id">...</span></span></h2>
      
      <div class="graph-toolbar">
        <!-- Controls Section -->
        <div class="toolbar-section">
          <div class="section-header" onclick="toggleSection('graph-controls-section')">
            <span class="toggle-icon">‚ñº</span>
            <strong>Graph Controls</strong>
          </div>
          <div id="graph-controls-section" class="section-content">
            <div class="control-group">
              <label for="query-select">Query:</label>
              <select id="query-select">
                <option value="full">Full Graph</option>
                <option value="circular">Circular Deps</option>
                <option value="critical">Critical Files</option>
                <option value="programs">Programs Only</option>
                <option value="copybooks">Copybooks Only</option>
              </select>
            </div>
            <div class="control-group">
              <label for="layout-select">Layout:</label>
              <select id="layout-select">
                <option value="force">Force Directed</option>
                <option value="hierarchical">Hierarchical</option>
              </select>
            </div>
            <div class="control-group">
              <button id="refresh-graph" type="button" class="btn-small">‚ü≥ Refresh</button>
              <button id="fit-graph" type="button" class="btn-small">‚ä° Fit</button>
              <button id="stabilize-graph" type="button" class="btn-small">‚ö° Stabilize</button>
            </div>
          </div>
        </div>

        <!-- Node Filters Section -->
        <div class="toolbar-section">
          <div class="section-header" onclick="toggleSection('node-filters-section')">
            <span class="toggle-icon">‚ñº</span>
            <strong>Node Filters</strong>
          </div>
          <div id="node-filters-section" class="section-content">
            <label class="filter-checkbox">
              <input type="checkbox" id="show-programs" checked>
              <span>Programs</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" id="show-copybooks" checked>
              <span>Copybooks</span>
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" id="show-called-programs" checked>
              <span>Called Programs</span>
            </label>
          </div>
        </div>

        <!-- Edge Filters Section -->
        <div class="toolbar-section">
          <div class="section-header" onclick="toggleSection('edge-filters-section')">
            <span class="toggle-icon">‚ñº</span>
            <strong>Edge Filters</strong>
          </div>
          <div id="edge-filters-section" class="section-content">
            <div class="edge-filter-group">
              <label class="filter-checkbox">
                <input type="checkbox" id="show-call-edges" checked>
                <span>CALL</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" id="show-copy-edges" checked>
                <span>COPY</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" id="show-perform-edges" checked>
                <span>PERFORM</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" id="show-exec-edges" checked>
                <span>EXEC</span>
              </label>
            </div>
            <div class="edge-filter-group">
              <label class="filter-checkbox">
                <input type="checkbox" id="show-read-edges" checked>
                <span>READ</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" id="show-write-edges" checked>
                <span>WRITE</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" id="show-open-edges" checked>
                <span>OPEN</span>
              </label>
              <label class="filter-checkbox">
                <input type="checkbox" id="show-close-edges" checked>
                <span>CLOSE</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Legend Section -->
        <div class="toolbar-section">
          <div class="section-header" onclick="toggleSection('legend-section')">
            <span class="toggle-icon">‚ñº</span>
            <strong>Legend</strong>
          </div>
          <div id="legend-section" class="section-content">
            <div class="legend-grid">
              <!-- Node Types -->
              <div class="legend-item">
                <span class="legend-dot" style="background: #68bdf6"></span>
                <span>Program</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: #f16667"></span>
                <span>Copybook</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot" style="background: #10b981"></span>
                <span>Called Prog</span>
              </div>
              <!-- Edge Types -->
              <div class="legend-item">
                <span class="legend-line" style="background: #10b981"></span>
                <span>CALL</span>
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #3b82f6"></span>
                <span>COPY</span>
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #f59e0b"></span>
                <span>PERFORM</span>
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #8b5cf6"></span>
                <span>EXEC</span>
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #06b6d4"></span>
                <span>READ</span>
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #ec4899"></span>
                <span>WRITE</span>
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #84cc16"></span>
                <span>OPEN</span>
              </div>
              <div class="legend-item">
                <span class="legend-line" style="background: #ef4444"></span>
                <span>CLOSE</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="dependency-graph"></div>
      <div id="graph-info" class="graph-info"></div>
      <div id="node-details" class="node-details" hidden>
        <h3>Node Details</h3>
        <button id="close-details" type="button">√ó</button>
        <div id="details-content"></div>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 COBOL Migration Portal | Powered by Model Context Protocol & Neo4j</p>
  </footer>

  <!-- All Runs & Data Guide Modal -->
  <div id="allRunsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìä All Migration Runs & Data Retrieval Guide</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-button active" data-tab="runs">All Runs</button>
          <button class="tab-button" data-tab="sqlite">SQLite Guide</button>
          <button class="tab-button" data-tab="neo4j">Neo4j Guide</button>
          <button class="tab-button" data-tab="api">API Guide</button>
        </div>
        
        <div id="runsTab" class="tab-content active">
          <h3>Available Migration Runs</h3>
          <div id="runsList" class="runs-list"></div>
        </div>
        
        <div id="sqliteTab" class="tab-content">
          <h3>üìä SQLite Database Access</h3>
          <div class="info-box">
            <p><strong>Location:</strong> <code>Data/migration.db</code></p>
            <p><strong>Purpose:</strong> Stores migration metadata, COBOL files, analyses, Java code</p>
          </div>
          
          <h4>Common Queries</h4>
          <div class="query-box">
            <pre><code>-- List all migration runs
SELECT id, status, started_at, completed_at, 
       total_files, successful_conversions 
FROM migration_runs 
ORDER BY id DESC;

-- Get files for specific run
SELECT file_name, file_type, file_path 
FROM cobol_files 
WHERE migration_run_id = 43;

-- Get analyses for specific run
SELECT cobol_file_id, analysis_json 
FROM analyses 
WHERE migration_run_id = 43;

-- Get generated Java for specific run
SELECT file_name, java_code, target_path 
FROM java_files 
WHERE migration_run_id = 43;</code></pre>
          </div>
          
          <h4>Access Tools</h4>
          <ul>
            <li><strong>sqlite3 CLI:</strong> <code>sqlite3 Data/migration.db</code></li>
            <li><strong>DB Browser for SQLite:</strong> <a href="https://sqlitebrowser.org/" target="_blank">Download</a></li>
            <li><strong>VS Code Extension:</strong> Search for "SQLite" by alexcvzz</li>
          </ul>
        </div>
        
        <div id="neo4jTab" class="tab-content">
          <h3>üîó Neo4j Graph Database Access</h3>
          <div class="info-box">
            <p><strong>Location:</strong> <code>bolt://localhost:7687</code></p>
            <p><strong>Browser:</strong> <a href="http://localhost:7474" target="_blank">http://localhost:7474</a></p>
            <p><strong>Credentials:</strong> neo4j / cobol-migration-2025</p>
            <p><strong>Purpose:</strong> Stores dependency graphs and file relationships</p>
          </div>
          
          <h4>Common Cypher Queries</h4>
          <div class="query-box">
            <pre><code>// List all runs
MATCH (r:Run) 
RETURN r.runId, r.status, r.totalFiles, r.startedAt 
ORDER BY r.runId DESC;

// Get all files for specific run
MATCH (r:Run {runId: 43})-[:CONTAINS]->(f:CobolFile) 
RETURN f.fileName, f.fileType;

// Get dependencies for specific run
MATCH (r:Run {runId: 43})-[:CONTAINS]->(source:CobolFile)
      -[d:DEPENDS_ON]->(target:CobolFile) 
RETURN source.fileName, target.fileName, d.dependencyType;

// Find circular dependencies
MATCH (r:Run {runId: 43})-[:CONTAINS]->(f:CobolFile) 
MATCH path = (f)-[:DEPENDS_ON*2..]->(f) 
RETURN [node in nodes(path) | node.fileName] as cycle;

// Get critical files (high fan-in)
MATCH (r:Run {runId: 43})-[:CONTAINS]->(f:CobolFile) 
OPTIONAL MATCH (f)<-[d:DEPENDS_ON]-() 
WITH f, count(d) as dependents 
WHERE dependents > 0 
RETURN f.fileName, dependents 
ORDER BY dependents DESC;</code></pre>
          </div>
          
          <h4>Access Tools</h4>
          <ul>
            <li><strong>Neo4j Browser:</strong> <a href="http://localhost:7474" target="_blank">Open in Browser</a></li>
            <li><strong>Cypher Shell:</strong> <code>cypher-shell -a bolt://localhost:7687 -u neo4j -p cobol-migration-2025</code></li>
            <li><strong>Neo4j Desktop:</strong> <a href="https://neo4j.com/download/" target="_blank">Download</a></li>
          </ul>
        </div>
        
        <div id="apiTab" class="tab-content">
          <h3>üåê MCP API Access</h3>
          <div class="info-box">
            <p><strong>Base URL:</strong> <code>http://localhost:5028</code></p>
            <p><strong>Purpose:</strong> REST API for accessing migration data via MCP</p>
          </div>
          
          <h4>Available Endpoints</h4>
          <div class="query-box">
            <pre><code># Get all run IDs
curl http://localhost:5028/api/runs/all

# Get dependencies for specific run
curl http://localhost:5028/api/runs/43/dependencies | jq '.'

# List all MCP resources
curl http://localhost:5028/api/resources

# Ask questions via chat
curl -X POST http://localhost:5028/api/chat \
  -H 'Content-Type: application/json' \
  -d '{"prompt":"Show me all dependencies for run 43"}'

# Get current run info
curl http://localhost:5028/api/runinfo

# Get data retrieval guide (this info as JSON)
curl http://localhost:5028/api/data-retrieval-guide</code></pre>
          </div>
          
          <h4>MCP Resource URIs</h4>
          <ul>
            <li><code>insights://runs/{runId}/summary</code> - Migration run overview</li>
            <li><code>insights://runs/{runId}/files</code> - All COBOL files list</li>
            <li><code>insights://runs/{runId}/graph</code> - Full dependency graph</li>
            <li><code>insights://runs/{runId}/circular-dependencies</code> - Circular deps</li>
            <li><code>insights://runs/{runId}/critical-files</code> - High-impact files</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Architecture Documentation Modal -->
  <div id="architectureModal" class="modal">
    <div class="modal-content modal-content-wide">
      <div class="modal-header">
        <h2>üìÑ Reverse Engineering Architecture Documentation</h2>
        <span class="close arch-close">&times;</span>
      </div>
      <div class="modal-body">
        <div class="doc-toolbar">
          <button id="downloadMarkdownBtn" class="doc-button">‚¨áÔ∏è Download Markdown</button>
          <button id="copyToClipboardBtn" class="doc-button">üìã Copy to Clipboard</button>
          <span id="docLastModified" class="doc-meta"></span>
        </div>
        <div id="architectureContent" class="doc-content">
          <p>Loading documentation...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="run-selector.js"></script>
  <script src="graph.js"></script>
  <script src="main.js"></script>
  <script src="runs-viewer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Toggle collapsible sections
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (!section) {
        console.error('Section not found:', sectionId);
        return;
      }
      
      // Find the header within the same parent
      const parent = section.parentElement;
      const header = parent.querySelector('.section-header');
      const icon = header ? header.querySelector('.toggle-icon') : null;
      
      if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'flex';
        if (icon) icon.textContent = '‚ñº';
      } else {
        section.style.display = 'none';
        if (icon) icon.textContent = '‚ñ∂';
      }
    }
  </script>
</body>
</html>